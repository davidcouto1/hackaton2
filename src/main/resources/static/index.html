<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Simulação de Empréstimo - HACKATON</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #005ca9 0%, #00a1e0 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 40px auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            padding: 40px 40px;
        }
        h1 {
            color: #005ca9;
            text-align: center;
            margin-bottom: 32px;
            font-size: 2rem;
            letter-spacing: 1px;
        }
        h2 {
            color: #0070c0;
            margin-bottom: 12px;
        }
        input, button, select {
            margin: 5px 0;
            padding: 10px;
            width: 100%;
            border-radius: 6px;
            border: 1px solid #cce6f6;
            font-size: 1rem;
        }
        input:focus, button:focus {
            outline: none;
            border-color: #0070c0;
        }
        button {
            background: #005ca9;
            color: #fff;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background: #0070c0;
        }
        .result {
            background: #eaf6fb;
            padding: 12px;
            margin-top: 10px;
            white-space: pre-wrap;
            border-radius: 6px;
            border: 1px solid #cce6f6;
        }
        .section {
            margin-bottom: 32px;
            border-bottom: 1px solid #eaf6fb;
            padding-bottom: 24px;
            background: #f8fbfd;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,92,169,0.04);
            padding-top: 18px;
        }
        table {
            margin-top: 10px;
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: #fff;
            box-shadow: 0 2px 12px rgba(0,92,169,0.08);
            border-radius: 12px;
            overflow: hidden;
        }
        th, td {
            padding: 12px 16px;
            border-bottom: 1px solid #eaf6fb;
            text-align: left;
            word-break: break-word;
            font-size: 1rem;
        }
        th {
            background: linear-gradient(90deg, #eaf6fb 0%, #cce6f6 100%);
            font-weight: bold;
            color: #005ca9;
            border-bottom: 2px solid #cce6f6;
        }
        tr:last-child td {
            border-bottom: none;
        }
        tr:hover td {
            background: #f0f8ff;
        }
        table {
            transition: box-shadow 0.2s;
        }
        .result {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 420px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,92,169,0.06);
            border: 1px solid #eaf6fb;
        }
        .result {
            overflow-x: auto;
        }
        @media (max-width: 900px) {
            .container {
                max-width: 98vw;
                padding: 8vw 2vw;
            }
            table, th, td {
                font-size: 0.95rem;
                padding: 8px 6px;
            }
        }
        @media (max-width: 600px) {
            .container {
                max-width: 100vw;
                padding: 2vw 1vw;
            }
            table, th, td {
                font-size: 0.85rem;
                padding: 6px 2px;
            }
            th, td {
                min-width: 80px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Simulação de Empréstimo - HACKATON</h1>

    <div class="section">
        <h2>Simulação de Crédito</h2>
        <form id="simulacaoForm">
            <input type="number" id="valor" placeholder="Valor">
            <input type="number" id="parcelas" placeholder="Parcelas">
            <button type="submit">Enviar Simulação</button>
        </form>
        <div id="simulacaoResult" class="result"></div>
    </div>

    <div class="section">
        <h2>Listar Simulações</h2>
        <button onclick="listarSimulacoes()">Listar Simulações</button>
        <div id="listarSimulacoesResult" class="result"></div>
    </div>

    <div class="section">
        <h2>Listar Produtos</h2>
        <button onclick="listarProdutos()">Listar Produtos</button>
        <div id="produtosResult" class="result"></div>
    </div>

    <div class="section">
        <h2>Relatório por Produto e Dia</h2>
        <input type="date" id="relatorioData">
        <button onclick="getRelatorioPorProdutoDia()">Consultar Relatório</button>
        <div id="relatorioProdutoDiaResult" class="result"></div>
    </div>

    <div class="section">
        <h2>Listar Telemetria</h2>
        <button onclick="getTelemetria()">Consultar Telemetria</button>
        <div id="telemetriaResult" class="result"></div>
    </div>
</div>

<script>
function showError(id, message) {
    const container = document.getElementById(id);
    container.innerHTML = `<div style='background:#ffeaea;border:1px solid #ffb3b3;color:#a80000;padding:16px;border-radius:8px;font-weight:bold;text-align:center;margin:8px 0;'>${message}</div>`;
}

function showTable(id, data, columns) {
    const container = document.getElementById(id);
    if (!data || (Array.isArray(data) && data.length === 0)) {
        container.innerHTML = '<em>Nenhum resultado encontrado.</em>';
        return;
    }
    let rows = '';
    if (Array.isArray(data)) {
        data.forEach(item => {
            rows += '<tr>' + columns.map(col => `<td>${item[col] ?? ''}</td>`).join('') + '</tr>';
        });
    } else if (typeof data === 'object') {
        rows += '<tr>' + columns.map(col => `<td>${data[col] ?? ''}</td>`).join('') + '</tr>';
    }
    container.innerHTML = `<div style='overflow-x:auto;'><table>`
        + `<thead><tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr></thead>`
        + `<tbody>${rows}</tbody></table></div>`;
}

function showResult(id, data) {
    const container = document.getElementById(id);
    if (typeof data === 'string') {
        showError(id, data);
    } else if (Array.isArray(data) && data.length > 0) {
        showTable(id, data, Object.keys(data[0]));
    } else if (typeof data === 'object' && data !== null) {
        if (data.erro) {
            showError(id, data.erro);
        } else {
            showTable(id, [data], Object.keys(data));
        }
    } else {
        container.textContent = JSON.stringify(data, null, 2);
    }
}

// Simulação
const simulacaoForm = document.getElementById('simulacaoForm');
simulacaoForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const valor = document.getElementById('valor').value;
    const parcelas = document.getElementById('parcelas').value;
    fetch('/api/simulacoes', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ valorDesejado: valor, prazo: parcelas })
    })
    .then(res => res.json())
    .then(data => {
        if (data && data.erro) {
            showError('simulacaoResult', data.erro);
        } else if (data && typeof data === 'object') {
            showTable('simulacaoResult', [data], ['idSimulacao','nomeProduto','taxaJuros']);
            if (Array.isArray(data.resultadosSimulacao)) {
                data.resultadosSimulacao.forEach(sim => {
                    let div = document.createElement('div');
                    div.innerHTML = `<b>${sim.tipo}</b>`;
                    document.getElementById('simulacaoResult').appendChild(div);
                    let tbl = document.createElement('div');
                    tbl.innerHTML = showTableHtml(sim.parcelas, ['numero','valorAmortizacao','valorJuros','valorPrestacao']);
                    document.getElementById('simulacaoResult').appendChild(tbl);
                });
            }
        } else {
            showResult('simulacaoResult', data);
        }
    })
    .catch(err => showError('simulacaoResult', err));
});

function showTableHtml(data, columns) {
    if (!data || (Array.isArray(data) && data.length === 0)) {
        return '<em>Nenhum resultado encontrado.</em>';
    }
    let rows = '';
    if (Array.isArray(data)) {
        data.forEach(item => {
            rows += '<tr>' + columns.map(col => `<td>${item[col] ?? ''}</td>`).join('') + '</tr>';
        });
    } else if (typeof data === 'object') {
        rows += '<tr>' + columns.map(col => `<td>${data[col] ?? ''}</td>`).join('') + '</tr>';
    }
    return `<table style="width:100%;border-collapse:collapse;">`
        + `<thead><tr>${columns.map(col => `<th style='border-bottom:1px solid #ccc;text-align:left;padding:4px;'>${col}</th>`).join('')}</tr></thead>`
        + `<tbody>${rows}</tbody></table>`;
}

// Listar Simulações
function listarSimulacoes() {
    fetch('/api/simulacoes')
    .then(res => res.json())
    .then(data => {
        if (data && data.registros) {
            showTable('listarSimulacoesResult', data.registros, ['idSimulacao','valorDesejado','prazo','valorTotalSac','valorTotalPrice']);
        } else {
            showResult('listarSimulacoesResult', data);
        }
    })
    .catch(err => showResult('listarSimulacoesResult', err));
}

// Listar Produtos
function listarProdutos() {
    fetch('/api/produtos')
    .then(res => res.json())
    .then(data => {
        if (Array.isArray(data)) {
            showTable('produtosResult', data, Object.keys(data[0] ?? {}));
        } else if (typeof data === 'object' && data !== null) {
            showTable('produtosResult', [data], Object.keys(data));
        } else {
            showResult('produtosResult', data);
        }
    })
    .catch(err => showResult('produtosResult', err));
}

// Relatório por Produto/Dia
function getRelatorioPorProdutoDia() {
    const data = document.getElementById('relatorioData').value;
    if (!data) {
        showError('relatorioProdutoDiaResult', 'Selecione uma data.');
        return;
    }
    fetch('/api/relatorio/por-produto-dia?data=' + data)
    .then(res => res.json())
    .then(data => {
        if (data && data.erro) {
            showError('relatorioProdutoDiaResult', data.erro);
        } else if (data && Array.isArray(data.simulacoes)) {
            showTable('relatorioProdutoDiaResult', data.simulacoes, Object.keys(data.simulacoes[0] ?? {}));
        } else if (typeof data === 'object' && data !== null) {
            showTable('relatorioProdutoDiaResult', [data], Object.keys(data));
        } else {
            showResult('relatorioProdutoDiaResult', data);
        }
    })
    .catch(err => showError('relatorioProdutoDiaResult', err));
}

// Telemetria
function getTelemetria() {
    fetch('/api/telemetria')
    .then(res => res.json())
    .then(data => {
        if (data && Array.isArray(data.listaEndpoints)) {
            showTable('telemetriaResult', data.listaEndpoints, Object.keys(data.listaEndpoints[0] ?? {}));
        } else if (typeof data === 'object' && data !== null) {
            showTable('telemetriaResult', [data], Object.keys(data));
        } else {
            showResult('telemetriaResult', data);
        }
    })
    .catch(err => showResult('telemetriaResult', err));
}
</script>
</body>
</html>
